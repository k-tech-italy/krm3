# KRM3 nginx site configuration template
# This file uses envsubst for templating - variables are replaced at container startup
#
# Variables provided by Django (via export_nginx_vars command):
#   ${DJANGO_ROUTES_PATTERN} - Regex pattern matching Django URL routes
#   ${STATIC_URL}            - Static files URL prefix (e.g., /static)
#   ${MEDIA_URL}             - Media files URL prefix (e.g., /media)
#   ${PRIVATE_MEDIA_URL}     - Private media URL prefix (e.g., /protected-media)
#
# Variables from environment:
#   ${KRM3_STATIC_ROOT}      - Filesystem path to static files
#   ${KRM3_MEDIA_ROOT}       - Filesystem path to media files (public)
#   ${KRM3_PRIVATE_MEDIA_ROOT} - Filesystem path to private media files

upstream django {
    server 127.0.0.1:8000;
}

server {
    listen 8080;
    server_name _;

    client_max_body_size 100M;

    # Logging
    access_log /var/log/nginx/krm3_access.log;
    error_log /var/log/nginx/krm3_error.log;

    # Static files
    location ${STATIC_URL}/ {
        alias ${KRM3_STATIC_ROOT}/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Media files (public)
    location ${MEDIA_URL}/ {
        alias ${KRM3_MEDIA_ROOT}/;
        expires 7d;
        add_header Cache-Control "public";
    }

    # Protected media files (internal only - served via X-Accel-Redirect from Django)
    # Django views at /media-auth/ will validate permissions and return X-Accel-Redirect
    location ${PRIVATE_MEDIA_URL} {
        internal;
        alias ${KRM3_PRIVATE_MEDIA_ROOT}/;
    }

    # Django application routes (auto-detected from Django URLconf)
    location ~ ^(${DJANGO_ROUTES_PATTERN})$ {
        proxy_pass http://django;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # Preserve X-Forwarded-Proto from Ingress if present, otherwise use current scheme
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # Frontend SPA - serve index.html for all other routes
    location / {
        root ${KRM3_STATIC_ROOT};
        index index.html;
        try_files $uri $uri/ /index.html =404;
    }
}
